// subject.c
// Generated by decompiling subject.exe
// using Reko decompiler version VERSION

#include "subject.h"

// 00401005: Register word32 fn00401005(Stack word32 dwArg04, Register out ptr32 ebxOut)
word32 fn00401005(word32 dwArg04, ptr32 & ebxOut)
{
	ptr32 eax_12 = fs->ptr0000;
	fs->ptr0000 = fp - 0x10;
	struct Eq_14 * esp_124 = fp - 44;
	if (dwArg04 == ~0x08)
	{
		word32 esp_133;
		word32 ebp_134;
		word32 eax_135;
		word32 ecx_137;
		byte SCZO_138;
		word32 ebx_139;
		word32 esi_140;
		word32 edi_141;
		byte SZO_142;
		byte C_143;
		byte Z_144;
		word32 edx_145;
		CxxThrowException();
		esp_124 = fp - 0x38;
	}
	if (dwArg04 == 0x00)
	{
		word32 * esp_106 = esp_124 - 0x04;
		*esp_106 = 0x00405070;
		*(esp_106 - 0x04) = fp - 0x1C;
		word32 esp_111;
		word32 ebp_112;
		word32 eax_113;
		word32 ecx_115;
		byte SCZO_116;
		word32 ebx_117;
		word32 esi_118;
		word32 edi_119;
		byte SZO_120;
		byte C_121;
		byte Z_122;
		word32 edx_123;
		CxxThrowException();
		esp_124 = esp_111 + ~0x03;
	}
	fs->ptr0000 = eax_12;
	word32 ebx_100;
	*ebxOut = esp_124->dw000C;
	return dwArg04 + 0x0A;
}

// 004014A8: Register Eq_77 Win32CrtStartup()
DWORD Win32CrtStartup()
{
	fn00401A50();
	word32 * ebp_10 = fn00401970(ebx, esi, edi, dwLoc0C, 4215192, 0x10);
	if (globals->dw4064E4 == 0x00)
	{
		*(fp - 0x0C) = 0x00;
		*(fp - 0x10) = 0x00;
		*(fp - 0x14) = 0x01;
		*(fp - 0x18) = 0x00;
		HeapSetInformation(*(fp - 0x18), *(fp - 0x14), *(fp - 0x10), *(fp - 0x0C));
	}
	*(ebp_10 - 0x04) = 0x00;
	Eq_107 esi_19 = fs->ptr0018->t0004;
	*(ebp_10 - 0x1C) = 0x00;
	while (true)
	{
		*(fp - 0x0C) = 0x00;
		*(fp - 0x10) = (int32) esi_19;
		*(fp - 0x14) = 0x004064CC;
		Eq_107 eax_29 = InterlockedCompareExchange(*(fp - 0x14), *(fp - 0x10), *(fp - 0x0C));
		ptr32 esp_190 = fp - 0x08;
		if (eax_29 == 0x00)
			break;
		if (eax_29 == esi_19)
		{
			*(ebp_10 - 0x1C) = 0x01;
			break;
		}
		*(fp - 0x0C) = 1000;
		Sleep(*(fp - 0x0C));
	}
	int32 eax_124;
	word32 esi_204 = 0x01;
	word32 eax_36 = globals->dw4064BC;
	if (eax_36 == 0x01)
	{
		*(fp - 0x0C) = 0x1F;
		ptr32 esp_195;
		word32 ebx_196;
		byte SZO_197;
		byte C_198;
		byte SCZO_199;
		byte Z_200;
		word32 eax_201;
		struct Eq_259 * fs_203;
		word32 edi_205;
		word32 ecx_206;
		amsg_exit();
		esp_190 = esp_195;
	}
	else
	{
		word32 eax_210 = globals->dw4064BC;
		if (eax_210 == 0x00)
		{
			globals->dw4064BC = 0x01;
			*(fp - 0x0C) = 4212248;
			*(fp - 0x10) = 0x0040430C;
			word32 esp_219;
			word32 ebx_220;
			byte SZO_221;
			byte C_222;
			byte SCZO_223;
			byte Z_224;
			word32 eax_225;
			struct Eq_292 * fs_227;
			word32 edi_229;
			word32 ecx_230;
			initterm_e();
			esp_190 = esp_219 + 0x04;
			if (eax_225 != 0x00)
			{
				*(ebp_10 - 0x04) = ~0x01;
				eax_124 = 0xFF;
				goto l004013A1;
			}
		}
		else
			globals->dw406184 = 0x01;
	}
	word32 eax_64 = globals->dw4064BC;
	if (eax_64 == esi_204)
	{
		word32 * esp_170 = esp_190 - 0x04;
		*esp_170 = 0x00404208;
		*(esp_170 - 0x04) = 0x00404000;
		word32 esp_174;
		word32 ebx_175;
		byte SZO_176;
		byte C_177;
		byte SCZO_178;
		byte Z_179;
		word32 eax_180;
		struct Eq_349 * fs_182;
		word32 esi_183;
		word32 edi_184;
		word32 ecx_185;
		initterm();
		globals->dw4064BC = 0x02;
		esp_190 = esp_174 + 0x04;
	}
	if (*(ebp_10 - 0x1C) == 0x00)
	{
		LONG * esp_164 = esp_190 - 0x04;
		*esp_164 = (int32) 0x00;
		*(esp_164 - 0x04) = 0x004064CC;
		InterlockedExchange(*(esp_164 - 0x04), *esp_164);
	}
	ptr32 esp_142 = esp_190;
	if (globals->ptr4064E8 != null)
	{
		word32 * esp_138 = esp_190 - 0x04;
		*esp_138 = 0x004064E8;
		word32 eax_140 = fn004018A0(dwArg00);
		esp_142 = esp_138 + 0x01;
		if (eax_140 != 0x00)
		{
			*esp_138 = 0x00;
			*(esp_138 - 0x04) = 0x02;
			*(esp_138 - 0x08) = 0x00;
			word32 ebx_153;
			byte SZO_154;
			byte C_155;
			byte SCZO_156;
			byte Z_157;
			word32 eax_158;
			struct Eq_468 * fs_160;
			word32 esi_161;
			word32 edi_162;
			word32 ecx_163;
			globals->ptr4064E8();
		}
	}
	*_initenv = globals->dw40616C;
	int32 * esp_94 = esp_142 - 0x04;
	*esp_94 = globals->dw40616C;
	*(esp_94 - 0x04) = globals->dw406170;
	*(esp_94 - 0x08) = globals->dw406168;
	word32 ebx_102;
	int32 eax_103 = fn00401005(dwArg00, out ebx_102);
	globals->dw406180 = eax_103;
	if (globals->dw406174 == ebx_102)
	{
		*esp_94 = eax_103;
		exit(*esp_94);
	}
	if (globals->dw406184 == ebx_102)
	{
		word32 esp_125;
		word32 ebx_126;
		byte SZO_127;
		byte C_128;
		byte SCZO_129;
		byte Z_130;
		word32 eax_131;
		struct Eq_502 * fs_133;
		word32 esi_134;
		word32 edi_135;
		word32 ecx_136;
		cexit();
	}
	*(ebp_10 - 0x04) = ~0x01;
	eax_124 = globals->dw406180;
l004013A1:
	fn004019B5(ebp_10, 0x10, dwArg00, dwArg04, dwArg08, dwArg0C);
	return eax_124;
}

// 00401810: Register word32 fn00401810(Stack word32 dwArg04)
word32 fn00401810(word32 dwArg04)
{
	if (dwArg04->w0000 == 23117)
	{
		struct Eq_516 * eax_39 = dwArg04 + dwArg04->dw003C / 0x0040;
		if (eax_39->dw0000 == 0x4550)
			return (word32) (eax_39->w0018 == 0x010B);
	}
	return 0x00;
}

// 00401850: Register (ptr Eq_533) fn00401850(Stack word32 dwArg04, Stack ui32 dwArg08)
Eq_533 * fn00401850(word32 dwArg04, ui32 dwArg08)
{
	struct Eq_536 * ecx_12 = dwArg04 + dwArg04->dw003C / 0x0040;
	uint32 esi_20 = (word32) ecx_12->w0006;
	uint32 edx_21 = 0x00;
	struct Eq_533 * eax_24 = &(ecx_12 + ((word32) ecx_12->w0014 + 0x18) / 22)->w0006 + 0x03;
	if (esi_20 != 0x00)
	{
		do
		{
			uint32 ecx_56 = eax_24->dw0000;
			if (dwArg08 >= ecx_56 && dwArg08 < eax_24->dw0008 + ecx_56)
				return eax_24;
			edx_21 = edx_21 + 0x01;
			eax_24 = eax_24 + 0x01;
		} while (edx_21 < esi_20);
	}
	eax_24 = null;
	return eax_24;
}

// 004018A0: Register ui32 fn004018A0(Stack word32 dwArg04)
ui32 fn004018A0(word32 dwArg04)
{
	ptr32 eax_16 = fs->ptr0000;
	fs->ptr0000 = fp - 0x14;
	if (fn00401810(0x00400000) != 0x00)
	{
		struct Eq_597 * eax_92 = fn00401850(0x00400000, dwArg04 - 0x00400000);
		if (eax_92 != null)
		{
			uint32 eax_99 = ~(eax_92->dw0024 >> 0x1F);
			fs->ptr0000 = eax_16;
			return eax_99 & 0x01;
		}
	}
	fs->ptr0000 = eax_16;
	return 0x00;
}

// 00401970: Register ptr32 fn00401970(Register word32 ebx, Register word32 esi, Register word32 edi, Stack word32 dwArg00, Stack word32 dwArg04, Stack word32 dwArg08)
ptr32 fn00401970(word32 ebx, word32 esi, word32 edi, word32 dwArg00, word32 dwArg04, word32 dwArg08)
{
	ptr32 esp_14 = fp - 0x08 - dwArg08;
	*(esp_14 - 0x04) = ebx;
	*(esp_14 - 0x08) = esi;
	*(esp_14 - 0x0C) = edi;
	*(esp_14 - 0x10) = globals->dw406020 ^ fp + 0x08;
	*(esp_14 - 0x14) = dwArg00;
	fs->ptr0000 = fp - 0x08;
	return fp + 0x08;
}

// 004019B5: void fn004019B5(Register (ptr word32) ebp, Stack word32 dwArg00, Stack word32 dwArg04, Stack word32 dwArg08, Stack word32 dwArg0C, Stack word32 dwArg10)
void fn004019B5(word32 * ebp, word32 dwArg00, word32 dwArg04, word32 dwArg08, word32 dwArg0C, word32 dwArg10)
{
	fs->dw0000 = *(ebp - 0x10);
	*ebp = dwArg00;
	return;
}

// 00401A50: void fn00401A50()
void fn00401A50()
{
	ui32 eax_10 = globals->dw406020;
	if (eax_10 != 0xBB40E64E && (eax_10 & 0xFFFF0000) != 0x00)
		globals->dw406024 = ~eax_10;
	else
	{
		GetSystemTimeAsFileTime(fp - 0x0C);
		ui32 esi_59 = dwLoc08 & 0x00 ^ dwLoc0C & 0x00 ^ GetCurrentProcessId() ^ GetCurrentThreadId() ^ GetTickCount();
		QueryPerformanceCounter(fp - 0x14);
		ui32 esi_69 = esi_59 ^ (dwLoc10 ^ dwLoc14);
		if (esi_69 == 0xBB40E64E)
			esi_69 = ~0x44BF19B0;
		else if ((esi_69 & 0xFFFF0000) == 0x00)
			esi_69 = esi_69 | (esi_69 | 0x4711) << 0x10;
		globals->dw406020 = esi_69;
		globals->dw406024 = ~esi_69;
	}
	return;
}

