// subject.c
// Generated by decompiling subject.exe
// using Reko decompiler version VERSION

#include "subject.h"

// 00401000: void fn00401000(Register word32 ecx, Register word32 ebx, Register word32 ebp)
void fn00401000(word32 ecx, word32 ebx, word32 ebp)
{
	LPTOP_LEVEL_EXCEPTION_FILTER * esp_163 = fp - 0x3C;
	<anonymous> * eax_11 = globals->ptr403074;
	if (eax_11 != null)
	{
		word32 esp_153;
		word32 ebp_154;
		byte SCZO_156;
		word32 eax_157;
		byte SZO_158;
		byte C_159;
		byte Z_160;
		word32 edx_161;
		eax_11();
		esp_163 = esp_153 - 0x0C;
	}
	*esp_163 = (LPTOP_LEVEL_EXCEPTION_FILTER *) &globals->t401110;
	struct Eq_18 * esp_28 = (char *) esp_163 + 0x04;
	*(esp_28 - 0x04) = (LPTOP_LEVEL_EXCEPTION_FILTER *) SetUnhandledExceptionFilter(*esp_163);
	word32 ecx_31 = fn00401514(ecx, ebx);
	fn004015F4();
	esp_28->ptr000C = fp - 0x14;
	esp_28->dw0008 = globals->dw402000;
	esp_28->ptr0004 = fp - 0x10;
	esp_28->dw0000 = 0x00405004;
	*(esp_28 - 0x04) = 0x00405000;
	struct Eq_66 * esp_41;
	word32 ebp_42;
	word32 ebx_43;
	byte SCZO_44;
	word32 eax_45;
	byte SZO_46;
	byte C_47;
	byte Z_48;
	word32 edx_49;
	word32 ecx_50;
	_getmainargs();
	byte * eax_52 = globals->ptr405034;
	if (eax_52 != null)
	{
		globals->ptr402004 = eax_52;
		esp_41->ptr0000 = eax_52;
		word32 eax_105 = iob->dw0010;
		esp_41->dwFFFFFFFC = eax_105;
		struct Eq_107 * esp_107;
		word32 ebp_108;
		struct Eq_109 * ebx_109;
		byte SCZO_110;
		word32 eax_111;
		byte SZO_112;
		byte C_113;
		byte Z_114;
		word32 edx_115;
		word32 ecx_116;
		setmode();
		esp_107->ptr0000 = globals->ptr405034;
		word32 eax_120 = ebx_109->dw0030;
		esp_107->dwFFFFFFFC = eax_120;
		struct Eq_131 * esp_122;
		word32 ebp_123;
		struct Eq_133 * ebx_124;
		byte SCZO_125;
		word32 eax_126;
		byte SZO_127;
		byte C_128;
		byte Z_129;
		word32 edx_130;
		word32 ecx_131;
		setmode();
		esp_122->ptr0000 = globals->ptr405034;
		word32 eax_135 = ebx_124->dw0050;
		esp_122->dwFFFFFFFC = eax_135;
		word32 esp_137;
		word32 ebp_138;
		word32 ebx_139;
		byte SCZO_140;
		word32 eax_141;
		byte SZO_142;
		byte C_143;
		byte Z_144;
		word32 edx_145;
		word32 ecx_146;
		setmode();
	}
	word32 esp_56;
	word32 ebp_57;
	word32 ebx_58;
	byte SCZO_59;
	byte ** eax_60;
	byte SZO_61;
	byte C_62;
	byte Z_63;
	word32 edx_64;
	Eq_176 ecx_65;
	_p__fmode();
	byte * edx_67 = globals->ptr402004;
	*eax_60 = (byte **) edx_67;
	word32 edx_69;
	fn0040172C(ecx_65, edx_67, ebp_57, out edx_69);
	__align(esp_56 + ~0x03);
	word32 eax_71 = fn00401974();
	struct Eq_202 * esp_72;
	word32 ebp_73;
	word32 ebx_74;
	byte SCZO_75;
	word32 * eax_76;
	byte SZO_77;
	byte C_78;
	byte Z_79;
	word32 edx_80;
	word32 ecx_81;
	_p__environ();
	esp_72->dw0004 = *eax_76;
	esp_72->dw0000 = globals->dw405004;
	word32 eax_87 = globals->dw405000;
	esp_72->dwFFFFFFFC = eax_87;
	fn0040138C(ebp);
	struct Eq_235 * esp_90;
	word32 ebp_91;
	word32 ebx_92;
	byte SCZO_93;
	word32 eax_94;
	byte SZO_95;
	byte C_96;
	byte Z_97;
	word32 edx_98;
	word32 ecx_99;
	cexit();
	esp_90->tFFFFFFFC = 0x00;
	ExitProcess(esp_90->tFFFFFFFC);
}

// 0040126C: Register Eq_257 Win32CrtStartup()
DWORD Win32CrtStartup()
{
	word32 esp_9;
	word32 ebp_10;
	byte SCZO_11;
	word32 eax_12;
	word32 ecx_13;
	word32 ebx_14;
	_set_app_type();
	fn00401000(ecx_13, ebx_14, ebp_10);
	word32 esp_22;
	word32 ebp_23;
	byte SCZO_24;
	word32 eax_25;
	word32 ecx_26;
	word32 ebx_27;
	_set_app_type();
	fn00401000(ecx_26, ebx_27, ebp_23);
	return fn0040129C();
}

// 0040129C: Register int32 fn0040129C()
int32 fn0040129C()
{
	return atexit(*esp_11);
}

// 0040138C: void fn0040138C(Stack word32 dwArg00)
void fn0040138C(word32 dwArg00)
{
	__align(fp);
	word32 eax_15 = fn00401974();
	word32 esp_18;
	word32 ecx_19;
	word32 ebp_20;
	byte SCZO_21;
	word32 eax_22;
	ZStlsISt11char_traitsIcEERSt13basic_ostreamIcT_ES5_PKc();
	word32 esp_26;
	word32 ecx_27;
	word32 ebp_28;
	byte SCZO_29;
	word32 eax_30;
	ZNSolsEPFRSoS_E();
	return;
}

// 00401514: Register word32 fn00401514(Register word32 ecx, Register word32 ebx)
word32 fn00401514(word32 ecx, word32 ebx)
{
	byte dh_17 = SLICE(SCZDOP, byte, 8);
	if (((SCZDOP ^ 0x00200000 ^ SCZDOP) & 0x00200000) != 0x00)
	{
		word32 eax_54;
		word32 ebx_55;
		word32 edx_57;
		__cpuid(0x00, ecx, &eax_54, &ebx_55, &ecx, &edx_57);
		if (eax_54 != 0x00)
		{
			word32 eax_62;
			word32 ebx_63;
			word32 ecx_64;
			ui32 edx_65;
			__cpuid(0x01, ecx, &eax_62, &ebx_63, &ecx_64, &edx_65);
			if ((dh_17 & 0x01) != 0x00)
				globals->dw405038 = globals->dw405038 | 0x01;
			if ((dh_17 & 0x80) != 0x00)
				globals->dw405038 = globals->dw405038 | 0x02;
			if ((edx_65 & 0x00800000) != 0x00)
				globals->dw405038 = globals->dw405038 | 0x04;
			if ((edx_65 & 0x01000000) != 0x00)
				globals->dw405038 = globals->dw405038 | 0x08;
			if ((edx_65 & 0x02000000) != 0x00)
				globals->dw405038 = globals->dw405038 | 0x10;
			if ((edx_65 & 0x04000000) != 0x00)
				globals->dw405038 = globals->dw405038 | 0x20;
			if ((cl & 0x01) != 0x00)
				globals->dw405038 = globals->dw405038 | 0x40;
			word32 ecx_91 = DPB(ecx_64, ch & 0x20, 8);
			if ((ch & 0x20) != 0x00)
				globals->dw405038 = globals->dw405038 | 0x80;
			uint32 eax_98;
			word32 ebx_99;
			word32 edx_101;
			__cpuid(0x80000000, ecx_91, &eax_98, &ebx_99, &ecx, &edx_101);
			if (eax_98 > 0x80000000)
			{
				word32 eax_105;
				word32 ebx_106;
				int32 edx_108;
				__cpuid(0x80000001, ecx, &eax_105, &ebx_106, &ecx, &edx_108);
				if (edx_108 < 0x00)
					globals->dw405038 = globals->dw405038 | 0x0100;
				if ((edx_108 & 0x40000000) != 0x00)
					globals->dw405038 = globals->dw405038 | 0x0200;
			}
		}
	}
	return ecx;
}

// 004015F4: void fn004015F4()
void fn004015F4()
{
fn004015F4_entry:
l004015F4:
fn004015F4_exit:
}

// 004015FC: Register (ptr code) fn004015FC(Register Eq_176 ecx, Register (ptr byte) edx, Stack word32 dwArg04, Register out Eq_463 ecxOut, Register out ptr32 edxOut, Register out (ptr Eq_465) ebxOut, Register out ptr32 ebpOut, Register out ptr32 esiOut)
code * fn004015FC(Eq_176 ecx, byte * edx, word32 dwArg04, Eq_463 & ecxOut, ptr32 & edxOut, Eq_465 * & ebxOut, ptr32 & ebpOut, ptr32 & esiOut)
{
	word32 esp_21;
	word32 ebp_22;
	word32 esi_23;
	word32 ebx_24;
	byte SCZO_25;
	word32 eax_26;
	word32 ecx_27;
	word32 edx_28;
	msvcrt.dll!fwrite();
	word32 esp_34;
	word32 ebp_35;
	word32 esi_36;
	word32 ebx_37;
	byte SCZO_38;
	Eq_193 eax_39;
	Eq_176 ecx_40;
	byte * edx_41;
	msvcrt.dll!vfprintf();
	abort();
	word32 edx_42;
	return fn00401648(eax_39, ecx_40, edx_41, out edx_42);
}

// 00401648: Register Eq_193 fn00401648(Register Eq_193 eax, Register Eq_176 ecx, Register (ptr byte) edx, Register out ptr32 edxOut)
Eq_193 fn00401648(Eq_193 eax, Eq_176 ecx, byte * edx, ptr32 & edxOut)
{
	*edxOut = edx;
	byte * esi_130 = edx;
	if (ecx != 0x00)
	{
		Eq_176 ecx_83 = ecx;
		if (VirtualQuery(eax, fp - 0x3C, 0x1C) == 0x00)
		{
			Eq_176 ecx_166;
			byte * edx_167;
			word32 ebx_168;
			word32 ebp_169;
			word32 esi_170;
			fn004015FC(ecx, edx, 0x00403090, out ecx_166, out edx_167, out ebx_168, out ebp_169, out esi_170);
			word32 edx_173;
			return fn0040172C(ecx_166, edx_167, ebp_169, out edx_173);
		}
		if (dwLoc28 == 0x40 || dwLoc28 == 0x04)
		{
			Eq_193 edi_90 = eax;
			while (ecx_83 != 0x00)
			{
				*edi_90 = *esi_130;
				esi_130 = esi_130 + 0x01;
				edi_90 = edi_90 + 0x01;
				ecx_83 = ecx_83 - 0x01;
			}
			return dwLoc28;
		}
		VirtualProtect(dwLoc3C, dwLoc30, 0x40, fp - 0x20);
		eax = dwLoc28;
		Eq_176 ecx_127 = ecx;
		Eq_193 edi_128 = eax;
		while (ecx_127 != 0x00)
		{
			*edi_128 = *esi_130;
			esi_130 = esi_130 + 0x01;
			edi_128 = edi_128 + 0x01;
			ecx_127 = ecx_127 - 0x01;
		}
		word32 edx_139;
		*edxOut = fp - 0x20;
		if (dwLoc28 != 0x40 && dwLoc28 != 0x04)
			return VirtualProtect(dwLoc3C, dwLoc30, dwLoc20, fp - 0x20);
	}
	return eax;
}

// 0040172C: Register (ptr code) fn0040172C(Register Eq_176 ecx, Register (ptr byte) edx, Register word32 ebp, Register out ptr32 edxOut)
code * fn0040172C(Eq_176 ecx, byte * edx, word32 ebp, ptr32 & edxOut)
{
	*edxOut = edx;
	ptr32 ebp_129 = fp - 0x04;
	struct Eq_599 * esp_130 = fp - 0x3C;
	<anonymous> * eax_115 = globals->ptr40503C;
	if (eax_115 != null)
		return eax_115;
	globals->ptr40503C = (<anonymous> *) 0x01;
	eax_115 = (<anonymous> *) 0x18;
	if (false)
		return eax_115;
	struct Eq_612 * ebx_109 = &globals->dw403128;
	if (true)
	{
		if (globals->dw403128 != 0x00)
			goto l00401780;
		if (globals->dw40312C != 0x00)
		{
l00401780:
			if (ebx_109 < (struct Eq_612 *) 0x00403140)
			{
				do
				{
					struct Eq_646 * eax_82 = ebx_109->dw0004;
					*(fp - 0x24) = eax_82->dw400000 + ebx_109->dw0000;
					word32 edx_90;
					<anonymous> * eax_91 = fn00401648(&eax_82->dw400000, 0x04, fp - 0x24, out edx_90);
					ebx_109 = ebx_109 + 0x01;
				} while (ebx_109 < (struct Eq_612 *) 0x00403140);
				return eax_91;
			}
			return eax_115;
		}
		ecx = globals->t403130;
		if (ecx != 0x00)
		{
l004017D9:
			eax_115 = (<anonymous> *) ebx_109[0x01];
			if (eax_115 != (<anonymous> *) 0x01)
			{
				word32 ecx_288;
				word32 edx_289;
				word32 ebx_290;
				word32 ebp_291;
				word32 esi_292;
				fn004015FC(ecx, edx, 0x004030C4, out ecx_288, out edx_289, out ebx_290, out ebp_291, out esi_292);
				*(fp - 0x44) = ebp_291;
				<anonymous> * eax_300 = globals->ptr402008->ptr0000;
				if (eax_300 != null)
				{
					do
					{
						word32 esp_320;
						word32 ebp_321;
						word32 edi_322;
						word32 esi_323;
						word32 ebx_324;
						byte SCZO_325;
						word32 eax_326;
						byte SZO_327;
						byte C_328;
						byte Z_329;
						word32 ecx_330;
						word32 edx_331;
						byte CZ_332;
						eax_300();
						struct Eq_695 * eax_333 = globals->ptr402008;
						globals->ptr402008 = &eax_333->ptr0004;
						word32 edx_334;
						*edxOut = &eax_333->ptr0004;
						eax_300 = eax_333->ptr0004;
					} while (eax_300 != null);
				}
				return eax_300;
			}
			Eq_701 ebx_118 = &ebx_109->dw0008 + 0x01;
			word32 ebx_121 = ebx_118 + 0x0C;
			if (ebx_118 >= ~0x00403133)
				return eax_115;
l004017F4:
			ui32 edi_210;
			Eq_176 ecx_141 = ebx_121->dw0000;
			ui32 edx_143 = ebx_121->dw0008;
			Eq_193 eax_140 = ebx_121->dw0004 + 0x00400000;
			word32 esi_142 = *((word32) ecx_141 + 0x00400000);
			word32 edx_144;
			*edxOut = edx_143 & 0xFF;
			if ((edx_143 & 0xFF) != 0x10)
			{
				if ((edx_143 & 0xFF) == 0x20)
				{
					*(ebp_129 - 0x1C) = (word32) (*eax_140 - ecx_141 - 0x00400000) + esi_142;
					goto l0040189F;
				}
				if ((edx_143 & 0xFF) != 0x08)
				{
					*(ebp_129 - 0x1C) = 0x00;
					esp_130[0x01] = (struct Eq_599) (edx_143 & 0xFF);
					esp_130->dw0000 = 0x004030F8;
					Eq_176 ecx_253;
					byte * edx_254;
					word32 ebx_255;
					ptr32 ebp_256;
					word32 esi_257;
					fn004015FC(ecx_141, edx_143 & 0xFF, dwArg00, out ecx_253, out edx_254, out ebx_255, out ebp_256, out esi_257);
					*(ebp_256 - 0x1C) = 0x00;
					struct Eq_818 * esp_259 = (char *) esp_130 - 0x04;
					esp_259->ptr0004 = edx_254;
					esp_259->dw0000 = 0x004030F8;
					eax_140 = fn004015FC(ecx_253, edx_254, dwArg00, out ecx_141, out edx_144, out ebx_121, out ebp_129, out esi_142);
					esp_130 = (struct Eq_599 *) ((char *) esp_259 - 0x04);
				}
				edi_210 = (word32) *eax_140;
				if ((edi_210 & 0x80) != 0x00)
				{
					*(ebp_129 - 0x1C) = (edi_210 | ~0xFF) - ecx_141 - 0x00400000 + esi_142;
					goto l00401881;
				}
			}
			else
			{
				edi_210 = (word32) *eax_140;
				if ((edi_210 & 0x8000) != 0x00)
				{
					*(ebp_129 - 0x1C) = (edi_210 | 0xFFFF0000) - ecx_141 - 0x00400000 + esi_142;
l004018D8:
					word32 edx_201;
					fn00401648(eax_140, 0x02, ebp_129 - 0x1C, out edx_201);
					goto l004018AC;
				}
			}
			*(ebp_129 - 0x1C) = edi_210 - ecx_141 - 0x00400000 + esi_142;
			if (edx_144 != 0x10)
			{
				if (edx_144 != 0x20)
				{
					if (edx_144 == 0x08)
					{
l00401881:
						word32 edx_173;
						fn00401648(eax_140, 0x01, ebp_129 - 0x1C, out edx_173);
						goto l004018AC;
					}
l004018AC:
					ebx_121 = ebx_121 + 0x0C;
					eax_115 = (<anonymous> *) 0x00403140;
					if ((struct Eq_706 *) 0x00403140 > ebx_121)
						goto l004017F4;
					return eax_115;
				}
l0040189F:
				word32 edx_187;
				fn00401648(eax_140, 0x04, ebp_129 - 0x1C, out edx_187);
				goto l004018AC;
			}
			goto l004018D8;
		}
		ebx_109 = &globals->t403134;
	}
	edx = ebx_109->dw0000;
	*edxOut = edx;
	if (edx != null)
		goto l00401780;
	eax_115 = ebx_109->dw0004;
	if (eax_115 != null)
		goto l00401780;
	goto l004017D9;
}

// 00401974: Register word32 fn00401974()
word32 fn00401974()
{
	word32 ecx_8 = globals->dw405040;
	if (ecx_8 == 0x00)
	{
		globals->dw405040 = 0x01;
		word32 * esp_41 = fp - 0x1C;
		ui32 ebx_42 = globals->dw401C60;
		if (ebx_42 == ~0x00)
		{
			ebx_42 = 0x00;
			while (true)
			{
				ui32 eax_82 = ebx_42 + 0x01;
				if ((&globals->dw401C60)[eax_82] == 0x00)
					break;
				ebx_42 = eax_82;
			}
		}
		if (ebx_42 != 0x00)
		{
			do
			{
				word32 ebp_66;
				byte SCZO_67;
				word32 ecx_68;
				byte SZO_69;
				byte C_70;
				byte Z_71;
				word32 ebx_72;
				word32 eax_73;
				word32 edx_74;
				(&globals->dw401C60)[ebx_42]();
			} while (ebx_72 != 0x01);
		}
		*esp_41 = 0x004018F8;
		return fn0040129C();
	}
	else
		return eax;
}

