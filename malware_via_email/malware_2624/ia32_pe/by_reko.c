// subject.c
// Generated by decompiling subject.exe
// using Reko decompiler version VERSION

#include "subject.h"

// 00401028: Register Eq_2 fn00401028(Register Eq_2 eax, Register word32 edx, Register word32 ebx, Register word32 edi)
DWORD fn00401028(DWORD eax, word32 edx, word32 ebx, word32 edi)
{
	word32 esp_3;
	byte SZO_4;
	word32 eax_5;
	byte SCZO_6;
	word32 * edi_7;
	struct Eq_12 * edx_8;
	byte Z_9;
	struct Eq_14 * ebx_10;
	word16 bx_11;
	byte al_12;
	fn00400FAC();
	return eax_5;
}

// 00412355: Register Eq_2 Win32CrtStartup()
DWORD Win32CrtStartup()
{
	GetProcessHeap();
	ptr32 esp_51 = fp + ~0x2B;
	do
	{
		LPCSTR * esp_10 = esp_51 - 0x04;
		*esp_10 = (LPCSTR *) &globals->t434CF7;
		Eq_52 eax_12 = GetModuleHandleA(*esp_10);
		GetCommandLineW();
		*esp_10 = (LPCSTR *) &globals->t434D1D;
		GetCurrentThreadId();
		GetVersion();
		*(esp_10 - 0x04) = (HMODULE *) eax_12;
		Eq_78 eax_24 = GetProcAddress(*(esp_10 - 0x04), *esp_10);
		GetCommandLineW();
		GetVersion();
		*esp_10 = (LPCSTR *) null;
		*(esp_10 - 0x04) = 0x00;
		*(esp_10 - 0x08) = 0x00;
		*(esp_10 - 0x0C) = 0x00;
		*(esp_10 - 0x10) = 0x0102;
		*(esp_10 - 0x14) = 0x03;
		*(esp_10 - 0x18) = 0x00;
		*(esp_10 - 0x1C) = 0x03;
		*(esp_10 - 0x20) = 0x40000000;
		*(esp_10 - 0x24) = 0x00434D01;
		Eq_40 eax_50 = CreateFileA(*(esp_10 - 0x24), *(esp_10 - 0x20), *(esp_10 - 0x1C), *(esp_10 - 0x18), *(esp_10 - 0x14), *(esp_10 - 0x10), *(esp_10 - 0x0C));
		esp_51 = esp_10 - 0x08;
	} while (eax_50 != (void *) ~0x00);
	GetCurrentThreadId();
	Eq_204 eax_59 = eax_24();
	GetACP();
	GetCommandLineA();
	<anonymous> * eax_73 = (eax_59 ^ 0xC0000005) + 0x00412419;
	ptr32 esp_75;
	word32 ebp_76;
	byte SCZO_77;
	word32 eax_78;
	byte Z_79;
	byte SZO_80;
	byte C_81;
	bcuiposr0 None_82;
	word32 edx_83;
	word32 ebx_84;
	word32 edi_85;
	eax_73();
	GetCurrentProcessId();
	*(esp_75 - 0x04) = (FARPROC *) eax_24;
	*(esp_75 - 0x08) = 0x00;
	SizeofResource(*(esp_75 - 0x08), *(esp_75 - 0x04));
	do
	{
		*(esp_75 - 0x04) = fp - 0x0C;
		GetACP();
		*(esp_75 - 0x08) = 0x40;
		GetProcessHeap();
		*(esp_75 - 0x0C) = 0x0001106D;
		GetCommandLineA();
		*(esp_75 - 0x10) = 0x00401000;
		GetCurrentProcessId();
		VirtualProtect(*(esp_75 - 0x10), *(esp_75 - 0x0C), *(esp_75 - 0x08), *(esp_75 - 0x04));
		*(esp_75 - 0x04) = 0x00;
		*(esp_75 - 0x08) = 288;
		*(esp_75 - 0x0C) = 0x03;
		*(esp_75 - 0x10) = 0x00;
		*(esp_75 - 0x14) = 0x04;
		*(esp_75 - 0x18) = 0xE0000000;
		*(esp_75 - 0x1C) = 0x00434D07;
	} while (CreateFileA(*(esp_75 - 0x1C), *(esp_75 - 0x18), *(esp_75 - 0x14), *(esp_75 - 0x10), *(esp_75 - 0x0C), *(esp_75 - 0x08), *(esp_75 - 0x04)) != (void *) ~0x00);
	*(esp_75 - 0x04) = (union Eq_204 *) eax_59;
	GetCurrentThreadId();
	*(esp_75 - 0x08) = 0x0001106D;
	*(esp_75 - 0x0C) = 0x00401000;
	*(esp_75 - 0x10) = 0x00;
	*(esp_75 - 0x14) = (HANDLE *) eax_50;
	GetFileSize(*(esp_75 - 0x14), *(esp_75 - 0x10));
	*(esp_75 - 0x10) = (HANDLE *) eax_50;
	CloseHandle(*(esp_75 - 0x10));
	ptr32 esp_154;
	word32 ebp_155;
	byte SCZO_156;
	word32 eax_157;
	byte Z_158;
	byte SZO_159;
	byte C_160;
	bcuiposr0 None_161;
	word32 edx_162;
	word32 ebx_163;
	word32 edi_164;
	(eax_59 - ~0x40412505)();
	*(esp_154 - 0x04) = (HANDLE *) eax_50;
	return fn00401028(GetFileType(*(esp_154 - 0x04)), edx_162, ebx_163, edi_164);
}

