//
// This file was generated by the Retargetable Decompiler
// Website: https://retdec.com
// Copyright (c) 2017 Retargetable Decompiler <info@retdec.com>
//

#include <stdbool.h>
#include <stdint.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <windows.h>

// ------------------- Function Prototypes --------------------

int32_t ___w32_eh_shared_initialize(char * a1);
int32_t ___w32_sharedptr_default_unexpected(void);
int32_t ___w32_sharedptr_fixup_after_fork(void);
int32_t ___w32_sharedptr_get(int32_t nAtom);
int32_t ___w32_sharedptr_initialize(void);
int32_t ___w32_sharedptr_set(int32_t a1, int32_t a2);
int32_t __cygwin_crt0_common_8(int32_t a1, int32_t * a2);
int32_t __RUNTIME_PSEUDO_RELOC_LIST_END__(void);
int32_t _cygwin_crt0(int32_t a1);
int32_t function_401301(void);
int main(int argc, char ** argv);

// --------------------- Global Variables ---------------------

int32_t g1 = 0; // eax
int32_t g2 = 0; // ebp
int32_t g3 = 0; // ebx
int32_t g4 = 0; // ecx
int32_t g5 = 0x4010e0; // 0x4010a8
int32_t g6 = -1; // 0x4017a0
int32_t g7 = 20; // 0x402000
int32_t g8 = 20; // 0x402004
int32_t g9 = 0; // 0x402008
int32_t g10 = 0; // 0x403000
int32_t g11 = 0; // 0x403010
int32_t g12 = 0; // 0x403020
int32_t g13 = 0; // 0x403024
int32_t g14 = 0; // 0x403028
int32_t g15 = 0; // 0x403030
int32_t g16 = 0; // 0x403040
int32_t g17 = 0; // 0x403050

// ------------------------ Functions -------------------------

// Address range: 0x401000 - 0x40103f
int32_t __RUNTIME_PSEUDO_RELOC_LIST_END__(void) {
    // 0x401000
    _cygwin_crt0((int32_t)main);
    return 0;
}

// Address range: 0x401080 - 0x40111f
int main(int argc, char ** argv) {
    int32_t v1;
    g2 = &v1;
    g3 = argc;
    int32_t v2;
    int32_t v3 = (int32_t)_alloca(v2); // 0x401091_3
    char v4 = v3;
    g1 = v3;
    __main();
    uint32_t v5 = g3; // 0x40109b
    char * str;
    if (v5 > 7) {
        // 0x4010e0
        str = "Other!";
        // branch -> 0x4010d0
    } else {
        // 0x4010a0
        ((int32_t (*)())*(int32_t *)(4 * v5 + (int32_t)&g5))();
        unsigned char v6 = *(char *)-0x38ffbfef; // 0x4010c3
        *(char *)-0x38ffbfef = (char)(g4 + (int32_t)v6);
        int32_t v7 = v4;
        uint32_t v8 = v7 + 36; // 0x4010c9
        int32_t v9 = v8 % 256 | v7 & -256; // 0x4010c9
        v1 = v9;
        char * v10 = (char *)v9; // 0x4010cc_0
        unsigned char v11 = *v10; // 0x4010cc
        *v10 = (char)((int32_t)(v4 > 219) + v8 + (int32_t)v11);
        str = (char *)v2;
        // branch -> 0x4010d0
    }
    // 0x4010d0
    puts(str);
    return 0;
}

// Address range: 0x401140 - 0x40115f
int32_t ___w32_sharedptr_default_unexpected(void) {
    int32_t v1;
    g2 = &v1;
    int32_t result = g16; // 0x401146
    g1 = result;
    ((int32_t (*)())*(int32_t *)(result + 4))();
    return result;
}

// Address range: 0x401160 - 0x4011cf
int32_t ___w32_eh_shared_initialize(char * a1) {
    int32_t v1 = (int32_t)a1; // ebx
    g4 = (int32_t)memset(a1, 0, 12);
    *(int32_t *)v1 = 48;
    *(int32_t *)(v1 + 36) = -1;
    *(int32_t *)(v1 + 4) = 0x401520;
    *(int32_t *)(v1 + 20) = g7;
    *(int32_t *)(v1 + 8) = 0x401140;
    *(int32_t *)(v1 + 28) = 0;
    *(int32_t *)(v1 + 32) = g11;
    *(int32_t *)(v1 + 44) = g9;
    *(int32_t *)(v1 + 40) = g8;
    return g8;
}

// Address range: 0x4011d0 - 0x401300
int32_t ___w32_sharedptr_initialize(void) {
    int32_t v1 = g16; // 0x4011d9
    int32_t result2 = v1; // 0x4011ee_2
    if (v1 == 0) {
        int32_t lpString = 0x41414141;
        int32_t v2;
        g4 = (int32_t)memcpy((char *)&v2, "-LIBGCCW32-EH-SJLJ-GTHR-CYGWIN", 7);
        v2 = 0x4e49;
        uint16_t v3 = FindAtomA((char *)&lpString); // 0x401252
        int32_t v4;
        int32_t result; // 0x4012be
        if (v3 == 0) {
            char * mem = malloc(48); // 0x40126d
            int32_t v5 = (int32_t)mem; // esi
            if (mem == NULL) {
                // 0x4012fc
                abort();
                // UNREACHABLE
            }
            // 0x40127c
            ___w32_eh_shared_initialize(mem);
            int32_t v6;
            if (___w32_sharedptr_set(v5, v6) == 0) {
                // 0x4012cb
                free((char *)v5);
                int32_t v7 = FindAtomA((char *)(int32_t)&lpString); // 0x4012f0
                // branch -> 0x4012f0
                // 0x4012f0
                v4 = ___w32_sharedptr_get(v7);
                // branch -> 0x4012b0
            } else {
                // 0x401291
                pthread_atfork(0, 0, (int32_t)___w32_sharedptr_fixup_after_fork);
                v4 = v5;
                // branch -> 0x4012b0
            }
            // 0x4012b0
            g16 = v4;
            g15 = v4 + 4;
            result = v4 + 8;
            g17 = result;
            // branch -> 0x4011e5
            // 0x4011e5
            return result;
        }
        // 0x4012f0
        v4 = ___w32_sharedptr_get((int32_t)v3);
        // branch -> 0x4012b0
        // 0x4012b0
        g16 = v4;
        g15 = v4 + 4;
        result = v4 + 8;
        g17 = result;
        result2 = result;
        // branch -> 0x4011e5
    }
    // 0x4011e5
    return result2;
}

// Address range: 0x401301 - 0x40130f
int32_t function_401301(void) {
    // 0x401301
    return ___w32_sharedptr_set(0, 0);
}

// Address range: 0x401310 - 0x40139f
int32_t ___w32_sharedptr_set(int32_t a1, int32_t a2) {
    int32_t v1;
    int32_t v2 = &v1; // 0x401310_0
    int32_t v3 = 31; // eax
    int32_t v4 = 1; // edx
    int32_t v5 = g3; // 0x40131f
    g3 = a1;
    int32_t v6 = 31; // 0x401338
    int32_t v7 = 1; // 0x401330
    // branch -> 0x401330
    while (true) {
        int32_t v8 = a1 == v7 ? 97 : 65;
        g4 = g4 & -256 | v8;
        *(char *)(v2 - 88 + v6) = (char)v8;
        int32_t v9 = 2 * v4; // 0x40133c
        v4 = v9;
        int32_t v10 = v3 - 1; // 0x40133e
        v3 = v10;
        if (v10 < 0) {
            // 0x401341
            int32_t v11;
            g4 = (int32_t)memcpy((char *)&v11, "-LIBGCCW32-EH-SJLJ-GTHR-CYGWIN", 7);
            v11 = 0x4e49;
            int32_t lpString;
            uint16_t v12 = AddAtomA((char *)&lpString); // 0x40136b
            int32_t result = v12; // 0x40136b_3
            if (v12 == 0 || ___w32_sharedptr_get(result) != g3) {
                // 0x40137b
                // branch -> 0x40137d
                // 0x40137d
                g3 = v5;
                return 0;
            }
            // 0x40137d
            g3 = v5;
            return result;
        }
        // 0x401330
        v6 = v10;
        a1 = g3;
        v7 = v9;
        // branch -> 0x401330
    }
}

// Address range: 0x4013a0 - 0x401400
int32_t ___w32_sharedptr_get(int32_t nAtom) {
    int32_t v1 = g3; // 0x4013a6
    g3 = 0;
    int32_t lpBuffer;
    if (GetAtomNameA((int16_t)nAtom, (char *)&lpBuffer, 63) == 0) {
        // 0x4013fc
        abort();
        // UNREACHABLE
    }
    int32_t v2 = 1; // 0x4013e7
    int32_t v3 = 31; // 0x4013e9
    // branch -> 0x4013e0
    while (true) {
        // 0x4013e0
        int32_t v4;
        if (*(char *)((int32_t)&v4 - 72 + v3) == 65) {
            // 0x4013f8
            g3 |= v2;
            // branch -> 0x4013e7
        }
        // 0x4013e7
        if (v3 < 1) {
            // break -> 0x4013ec
            break;
        }
        v2 *= 2;
        v3--;
        // continue -> 0x4013e0
    }
    int32_t result = g3; // 0x4013ec
    if (*(int32_t *)result == 48) {
        // 0x4013f1
        g3 = v1;
        return result;
    }
    // 0x4013fc
    abort();
    // UNREACHABLE
}

// Address range: 0x401410 - 0x40143f
int32_t ___w32_sharedptr_fixup_after_fork(void) {
    int32_t result = ___w32_sharedptr_set(g16, 0); // 0x40141e
    if (result != 0) {
        // 0x401428
        return result;
    }
    // 0x40142c
    abort();
    // UNREACHABLE
}

// Address range: 0x401470 - 0x4014cf
int32_t _cygwin_crt0(int32_t a1) {
    if (__cygwin_crt0_common_8(a1, NULL) == 0) {
      lab_0x4014a3:;
        // 0x4014a3
        int32_t v1;
        g3 = &v1;
        v1 = 0;
        __cygwin_crt0_common_8(a1, &v1);
        // branch -> 0x40149d
    }
    // 0x40149d
    dll_crt0__FP11per_process();
    // branch -> 0x4014a3
    goto lab_0x4014a3;
}

// Address range: 0x401530 - 0x40164b
int32_t __cygwin_crt0_common_8(int32_t a1, int32_t * a2) {
    int32_t v1 = (int32_t)a2;
    int32_t v2 = 0; // eax
    if (a2 == NULL) {
        // 0x401630
        cygwin_internal(8);
        if (v2 != -1) {
            // 0x401645
            return 1;
        }
        // 0x40161d
        return 0;
    }
    // 0x401544
    *(int32_t *)(v1 + 4) = 168;
    *(int32_t *)(v1 + 8) = 1005;
    *(int32_t *)(v1 + 12) = 9;
    *(int32_t *)(v1 + 128) = 0;
    *(int32_t *)(v1 + 132) = 112;
    *(int32_t *)(v1 + 44) = (int32_t)&g6;
    *(int32_t *)(v1 + 48) = 0x4017ac;
    *(int32_t *)(v1 + 20) = (int32_t)&g12;
    if (v2 == 0) {
        // 0x401624
        *(int32_t *)(v1 + 16) = (int32_t)&g13;
        // branch -> 0x401594
    } else {
        // 0x401589
        g13 = *(int32_t *)(v1 + 164);
        // branch -> 0x401594
    }
    // 0x401594
    *(int32_t *)(v1 + 120) = 0;
    *(int32_t *)(v1 + 72) = 0x401730;
    *(int32_t *)(v1 + 76) = 0x401720;
    *(int32_t *)(v1 + 40) = a1;
    *(int32_t *)(v1 + 80) = 0x401710;
    *(int32_t *)(v1 + 84) = 0x401700;
    *(int32_t *)(v1 + 36) = (int32_t)&g14;
    int32_t v3;
    *(int32_t *)v1 = v3;
    *(int32_t *)(v1 + 24) = 0x401510;
    *(int32_t *)(v1 + 28) = 0x4014f0;
    *(int32_t *)(v1 + 32) = 0x4016f0;
    *(int32_t *)(v1 + 68) = 0x4016e0;
    *(int32_t *)(v1 + 124) = (int32_t)GetModuleHandleA(NULL);
    *(int32_t *)(v1 + 52) = (int32_t)&g7;
    *(int32_t *)(v1 + 56) = 0x402010;
    *(int32_t *)(v1 + 60) = (int32_t)&g10;
    *(int32_t *)(v1 + 64) = 0x403080;
    pei386_runtime_relocator();
    // branch -> 0x40161d
    // 0x40161d
    return 1;
}

// --------------- Statically Linked Functions ----------------

// void * __cdecl _alloca(_In_ size_t Size);
// int pei386_runtime_relocator(void);

// --------------- Dynamically Linked Functions ---------------

// void __main(void);
// void abort(void);
// ATOM AddAtomA(_In_opt_ LPCSTR lpString);
// void cygwin_internal(int32_t a1);
// void dll_crt0__FP11per_process(void);
// ATOM FindAtomA(_In_opt_ LPCSTR lpString);
// void free(void * ptr);
// UINT GetAtomNameA(_In_ ATOM nAtom, LPSTR lpBuffer, _In_ int nSize);
// HMODULE GetModuleHandleA(_In_opt_ LPCSTR lpModuleName);
// void * malloc(size_t size);
// void pthread_atfork(int32_t a1, int32_t a2, int32_t a3);
// int puts(const char * s);

// --------------------- Meta-Information ---------------------

// Detected compiler/packer: gcc
// Detected functions: 11
// Decompiler release: VERSION
// Decompilation date: DATE
